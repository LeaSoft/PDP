name: ðŸš€ Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deployment-main
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_PHP: leasoft/pdp-php
  IMAGE_NAME_NGINX: leasoft/pdp-nginx

jobs:
  build-and-push:
    name: ðŸ—ï¸ Build & Push images to GHCR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      sha: ${{ steps.out.outputs.sha }}

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v5

      - name: ðŸ§± Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ˜ Build & Push PHP (amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          target: prod
          push: true
          platforms: linux/amd64
          provenance: false
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PHP }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PHP }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha,scope=pdp-php
          cache-to: type=gha,mode=max,scope=pdp-php

      - name: ðŸŒ Build & Push Nginx (amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          target: nginx
          push: true
          platforms: linux/amd64
          provenance: false
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_NGINX }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_NGINX }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha,scope=pdp-nginx
          cache-to: type=gha,mode=max,scope=pdp-nginx

      - name: ðŸ“¤ Set outputs
        id: out
        run: echo "sha=${{ github.sha }}" >> "$GITHUB_OUTPUT"

  deploy:
    name: ðŸš¢ Deploy to server
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ›°ï¸ SSH deploy
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -euo pipefail

            echo "ðŸ“‚ Switching to project directory..."
            cd /pdp/PDP

            echo "ðŸ”„ Updating repository..."
            git fetch origin main
            git reset --hard origin/main

            echo "ðŸ” Logging in to GHCR..."
            echo "${{ secrets.CR_PAT }}" | docker login ${{ env.REGISTRY }} -u ${{ secrets.GHCR_USER }} --password-stdin

            echo "ðŸ·ï¸ Using image tag from build job..."
            export IMAGE_TAG="${{ needs.build-and-push.outputs.sha }}"

            echo "ðŸ“¥ Pulling latest images..."
            docker compose -f docker-compose.prod.yaml pull

            echo "ðŸš€ Restarting services..."
            docker compose -f docker-compose.prod.yaml up -d

            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -f

            echo "âœ… Deployment finished!"

  cleanup:
    name: ðŸ§¹ Cleanup GHCR (5 latest + 10 sha)
    runs-on: ubuntu-latest
    needs: build-and-push

    env:
      GH_TOKEN: ${{ github.token }}

    strategy:
      matrix:
        package: [pdp-php, pdp-nginx]

    steps:
      - name: ðŸ” Auth GH CLI
        run: gh auth setup-git

      - name: ðŸ—‘ Smart cleanup ${{ matrix.package }}
        env:
          OWNER: ${{ github.repository_owner }}
          PACKAGE: ${{ matrix.package }}
        run: |
          echo "ðŸ§© Package: $PACKAGE"

          gh api --paginate "/orgs/$OWNER/packages/container/$PACKAGE/versions?per_page=100" > versions.json

          jq -r 'sort_by(.created_at) | reverse | .[].id' versions.json > all_ids.txt

          jq -r '
            map(select(.metadata.container.tags[]? == "latest"))
            | sort_by(.created_at) | reverse
            | .[].id
          ' versions.json | head -n 5 > keep_latest.txt

          jq -r '
            map(select(.metadata.container.tags[]? | startswith("sha-")))
            | sort_by(.created_at) | reverse
            | .[].id
          ' versions.json | head -n 10 > keep_sha.txt

          cat keep_latest.txt keep_sha.txt | sort -u > keep_ids.txt

          grep -vxF -f keep_ids.txt all_ids.txt | xargs -r -I{} gh api --method DELETE "/orgs/$OWNER/packages/container/$PACKAGE/versions/{}"

          echo "âœ… Done for $PACKAGE"
