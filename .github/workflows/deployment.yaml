name: ğŸš€ PDP | Deployment & Security

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deployment-main
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io

jobs:
  build:
    name: ğŸ³ Images | Build & push (${{ matrix.id }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - id: php
            target: prod
            image: leasoft/pdp-php
            cache_scope: pdp-php
          - id: nginx
            target: nginx
            image: leasoft/pdp-nginx
            cache_scope: pdp-nginx

    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¥ Repo | Checkout
        uses: actions/checkout@v5

      - name: âš™ï¸ Docker | Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Registry | Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§± Image | Build & push (${{ matrix.id }}) (amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          target: ${{ matrix.target }}
          push: true
          platforms: linux/amd64
          provenance: false
          tags: |
            ${{ env.REGISTRY }}/${{ matrix.image }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ matrix.image }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha,scope=${{ matrix.cache_scope }}
          cache-to: type=gha,mode=max,scope=${{ matrix.cache_scope }}

  trivy-scan:
    name: ğŸ” Security | Trivy scan & upload SARIF
    runs-on: ubuntu-latest
    needs: build

    strategy:
      fail-fast: false
      matrix:
        include:
          - id: php
            image: leasoft/pdp-php
          - id: nginx
            image: leasoft/pdp-nginx

    permissions:
      contents: read
      packages: read
      actions: read
      security-events: write

    steps:
      - name: ğŸ” Registry | Log in to GHCR (read)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§ª Security | Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ matrix.image }}:latest
          format: sarif
          output: trivy-${{ matrix.id }}.sarif
          ignore-unfixed: true
          severity: CRITICAL,HIGH
          limit-severities-for-sarif: true

      - name: ğŸ“ Security | Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-${{ matrix.id }}.sarif

  deploy:
    name: ğŸš¢ Prod | Deploy to server
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ” SSH | Deploy to PROD
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -euo pipefail

            echo "ğŸ“‚ Repo | Switch to project directory..."
            cd /pdp/PDP

            echo "ğŸ”„ Repo | Update from origin/main..."
            git fetch origin main
            git reset --hard origin/main

            echo "ğŸ” Registry | Log in to GHCR..."
            echo "${{ secrets.CR_PAT }}" | docker login ${{ env.REGISTRY }} -u ${{ secrets.GHCR_USER }} --password-stdin

            echo "ğŸ·ï¸ Image | Using tag from build..."
            export IMAGE_TAG="${{ github.sha }}"

            echo "ğŸ“¥ Compose | Pull latest images..."
            docker compose -f docker-compose.prod.yaml pull

            echo "ğŸš€ Compose | Restart services..."
            docker compose -f docker-compose.prod.yaml up -d

            echo "ğŸ§¹ Docker | Prune old images..."
            docker image prune -f

            echo "âœ… Prod | Deployment finished"

  cleanup:
    name: ğŸ§¹ Registry | Cleanup GHCR (keep last 10)
    runs-on: ubuntu-latest
    needs: build

    env:
      GH_TOKEN: ${{ github.token }}

    strategy:
      matrix:
        package: [pdp-php, pdp-nginx]

    steps:
      - name: ğŸ” GH CLI | Auth
        run: gh auth setup-git

      - name: ğŸ§¹ Registry | Cleanup ${{ matrix.package }}
        env:
          OWNER: ${{ github.repository_owner }}
          PACKAGE: ${{ matrix.package }}
        run: |
          echo "ğŸ§© Package: $PACKAGE"

          gh api --paginate "/orgs/$OWNER/packages/container/$PACKAGE/versions?per_page=100" \
          | jq -r 'sort_by(.created_at) | reverse | .[].id' \
          | tail -n +11 \
          | xargs -r -I{} gh api --method DELETE "/orgs/$OWNER/packages/container/$PACKAGE/versions/{}"

          echo "âœ… Cleanup finished for $PACKAGE"